name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      ref:
        description: "Git tag to build and publish (for backfills, e.g. v2.0.4)"
        required: true

permissions:
  contents: write

jobs:
  build-python-legacy:
    name: Build Legacy Python EXE (Windows)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || github.ref }}

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Python build dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyinstaller
          python -m pip install -r requirements.txt

      - name: Build legacy Python executable
        run: pyinstaller delete_real_duplicates.spec

      - name: Upload legacy Python artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-legacy-windows
          path: dist/*.exe
          if-no-files-found: error

  build-tauri:
    name: Build Tauri (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || github.ref }}

      - uses: actions/setup-node@v4
        with:
          node-version: "22"

      - uses: dtolnay/rust-toolchain@stable

      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libgtk-3-dev

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Install frontend dependencies
        run: npm ci

      - name: Build Tauri bundles
        run: npx tauri build

      - name: Upload Tauri artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tauri-${{ matrix.os }}
          path: src-tauri/target/release/bundle/**/*
          if-no-files-found: error

  publish:
    name: Publish GitHub Release Assets
    runs-on: ubuntu-latest
    needs: [build-python-legacy, build-tauri]

    steps:
      - name: Validate workflow_dispatch input
        if: github.event_name == 'workflow_dispatch'
        run: |
          case "${{ inputs.ref }}" in
            v*) ;;
            *)
              echo "workflow_dispatch 'ref' must be a tag starting with 'v' (got '${{ inputs.ref }}')"
              exit 1
              ;;
          esac

      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets

      - name: Show collected assets
        run: find release-assets -maxdepth 6 -type f | sort

      - name: Publish assets to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || github.ref_name }}
          name: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || github.ref_name }}
          generate_release_notes: true
          files: release-assets/**/*
          fail_on_unmatched_files: true
